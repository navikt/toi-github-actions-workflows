on:
  workflow_call:
    inputs:
      pnpm:
        required: false
        type: boolean
        default: false
      deploy-to-dev-only:
        required: false
        type: boolean
        default: false
      deploy-to-dev-if-branch-name-is:
        required: false
        type: string
      dev-vars-path:
        required: false
        type: string
        description: 'Path to VARS file for NAIS deployment'
        default: ''
      prod-vars-path:
        required: false
        type: string
        description: 'Path to VARS file for NAIS deployment'
        default: ''
      dev-yaml-path:
        required: false
        type: string
        description: 'Path to YAML file for NAIS deployment'
        default: '.nais/app.yaml'
      prod-yaml-path:
        required: false
        type: string
        description: 'Path to YAML file for NAIS deployment'
        default: '.nais/app.yaml'
      nais-alerts-path:
        required: false
        type: string
        description: 'Path to nais alert file'
        default: '.nais/alerts.yaml'
      playwright:
        required: false
        type: boolean
        default: false
      playwright-github-report:
        required: false
        type: boolean
        default: false
      storybook:
        required: false
        type: boolean
        default: false
      a11y:
        required: false
        type: boolean
        default: false
jobs:
  build:
    name: ğŸ—ï¸ Bygg applikasjon
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Hent Kildekode
        uses: actions/checkout@v4

      - name: ğŸ“¥ Sett opp pnpm
        if: ${{ inputs.pnpm == true }}
        uses: pnpm/action-setup@v4
        with:
          version: 9.14.2

      - name: ğŸ“¦ Sett opp Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.20.0'
          registry-url: 'https://npm.pkg.github.com'

      - name: ğŸ“¥ Installer Avhengigheter med pnpm
        if: ${{ inputs.pnpm == true }}
        uses: ./.github/actions/frontend/install-pnpm-dependencies
        env:
          NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}

      - name: ğŸ› ï¸ Bygg Next applikasjon med pnpm
        if: ${{ inputs.pnpm == true }}
        uses: ./.github/actions/frontend/build-next-pnpm

      - name: ğŸ“¥ Installer Avhengigheter med npm
        if: ${{ inputs.pnpm == false }}
        uses: ./.github/actions/frontend/install-npm-dependencies
        env:
          NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}

      - name: ğŸ› ï¸ Bygg Next applikasjon med npm
        if: ${{ inputs.pnpm == false }}
        uses: ./.github/actions/frontend/build-next-npm

      - name: Cache workspace
        uses: actions/cache/save@v4
        with:
          path: .
          key: workspace-${{ github.sha }}

      - name: ğŸ³ Last opp Docker-image til GAR
        id: docker-build-push
        uses: nais/docker-build-push@v0
        env:
          NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}
        with:
          team: toi
          build_secrets: 'NODE_AUTH_TOKEN=${{ secrets.READER_TOKEN }}'
          tag: ${{ contains(fromJSON('["refs/heads/master", "refs/heads/main"]'), github.ref) && 'latest' || github.sha }}
    outputs:
      image: ${{ steps.docker-build-push.outputs.image }}

  call-trivy-security-scan:
    name: ğŸ”’ Security Scan
    needs: build
    uses: navikt/toi-github-actions-workflows/.github/workflows/trivy-security-scan.yaml@v2
    with:
      image: ${{ needs.build.outputs.image }}
    permissions:
      id-token: write
      security-events: write
    secrets: inherit

  deploy-til-dev:
    name: ğŸš€ Deploy til dev-gcp
    needs:
      - build
    if: contains(fromJSON('["refs/heads/master", "refs/heads/main"]'), github.ref) || github.ref == format('refs/heads/{0}', inputs.deploy-to-dev-if-branch-name-is)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Hent Kildekode
        uses: actions/checkout@v4

      - name: ğŸ“¦ Deploy til Dev
        uses: nais/deploy/actions/deploy@v2
        env:
          CLUSTER: dev-gcp
          RESOURCE: ${{ inputs.dev-yaml-path }}
          VAR: image=${{ needs.build.outputs.image }}
          VARS: ${{ inputs.dev-vars-path }}

  playwright-tests:
    name: ğŸ­ Playwright Tests
    if: ${{ inputs.playwright }}
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: ğŸš€ Start testserver
        uses: ./.github/actions/frontend/next-testserver

      - name: Playwright
        uses: ./.github/actions/frontend/run-playwright-tests

      - uses: actions/upload-artifact@v4
        if: ${{  contains(fromJSON('["refs/heads/main"]'), github.ref) && !cancelled() && inputs.playwright-github-report == true }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Setup GitHub Pages
        if: ${{ contains(fromJSON('["refs/heads/main"]'), github.ref) && !cancelled() && inputs.playwright-github-report == true }}
        uses: actions/configure-pages@v3

      - name: Deploy Playwright Report to GitHub Pages
        if: ${{ contains(fromJSON('["refs/heads/main"]'), github.ref) && !cancelled() && inputs.playwright-github-report == true }}
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: playwright-report
          clean: false
          target-folder: playwright-report
          token: ${{ secrets.GITHUB_TOKEN }}

  a11y-tests:
    name: â™¿ Pa11y
    if: ${{ inputs.a11y }}
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ğŸš€ Start testserver
        uses: ./.github/actions/frontend/next-testserver

      - name: Pa11y
        uses: ./.github/actions/frontend/run-pa11y

  storybook:
    name: ğŸ“š Storybook
    needs: [build]
    if: ${{ inputs.storybook == true }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“š Bygg og deploy Storybook
        uses: ./.github/actions/frontend/build-storybook
        env:
          NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}
        with:
          use-pnpm: ${{ inputs.pnpm }}
          storybook-base-path: /rekrutteringsbistand-frontend/storybook/
          deploy-to-pages: ${{ contains(fromJSON('["refs/heads/main"]'), github.ref) }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  deploy-til-prod:
    name: ğŸš€ Deploy til prod-gcp
    needs:
      - build
      - deploy-til-dev
      - playwright-tests
      - a11y-tests
    if: ${{ !inputs.deploy-to-dev-only && contains(fromJSON('["refs/heads/master", "refs/heads/main"]'), github.ref) && (!inputs.playwright || needs.playwright-tests.result == 'success') && (!inputs.a11y || needs.a11y-tests.result == 'success') }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Hent Kildekode
        uses: actions/checkout@v4

      - name: ğŸ“¦ Deploy til Prod
        uses: nais/deploy/actions/deploy@v2
        env:
          CLUSTER: prod-gcp
          RESOURCE: ${{ inputs.prod-yaml-path }}${{ inputs.nais-alerts-path != '' && format(',{0}', inputs.nais-alerts-path) || '' }}
          VAR: image=${{ needs.build.outputs.image }}
          VARS: ${{ inputs.prod-vars-path }}

      - name: ğŸ“ Deployment Oppsummering
        if: success()
        uses: ./.github/actions/frontend/deployment-success-summary
        with:
          image: ${{ needs.build.outputs.image }}
          branch: ${{ github.ref_name }}
          commit: ${{ github.sha }}
          environment: Produksjon

      - name: âš ï¸ Deployment Feilet
        if: failure()
        uses: ./.github/actions/frontend/deployment-failure-summary
        with:
          image: ${{ needs.build.outputs.image }}
          branch: ${{ github.ref_name }}
          environment: Produksjon
