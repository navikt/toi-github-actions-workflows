name: 'Bygg og deploy Storybook'
description: 'KjÃ¸rer hele Storybook-pipelinen med valgfri distribusjon til GitHub Pages'

inputs:
  use-pnpm:
    description: 'Settes til true for Ã¥ bruke pnpm'
    required: false
    default: 'false'
  pnpm-version:
    description: 'pnpm-versjon nÃ¥r pnpm benyttes'
    required: false
    default: '9.14.2'
  node-version:
    description: 'Node-versjon som skal installeres'
    required: false
    default: '22.20.0'
  registry-url:
    description: 'NPM registry som skal brukes'
    required: false
    default: 'https://npm.pkg.github.com'
  output-dir:
    description: 'Mappen Storybook bygges til'
    required: false
    default: 'storybook-static'
  storybook-base-path:
    description: 'Base path for Storybook'
    required: false
    default: ''
  deploy-to-pages:
    description: 'Settes til true for Ã¥ deploye til GitHub Pages'
    required: false
    default: 'false'
  pages-branch:
    description: 'Branch for GitHub Pages'
    required: false
    default: 'gh-pages'
  pages-target-folder:
    description: 'Mappen pÃ¥ gh-pages-branchen'
    required: false
    default: 'storybook'
  github-token:
    description: 'Token som brukes av GitHub Pages deployment'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: ğŸ”„ Hent Kildekode
      uses: actions/checkout@v4

    - name: ğŸ“¥ Sett opp pnpm
      if: ${{ inputs['use-pnpm'] == 'true' }}
      uses: pnpm/action-setup@v4
      with:
        version: ${{ inputs['pnpm-version'] }}

    - name: ğŸ“¦ Sett opp Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs['node-version'] }}
        registry-url: ${{ inputs['registry-url'] }}

    - name: ğŸ“¥ Installer Avhengigheter
      shell: bash
      env:
        NODE_AUTH_TOKEN: ${{ env.NODE_AUTH_TOKEN }}
      run: |
        echo "::group::Installerer avhengigheter"
        if [ "${{ inputs['use-pnpm'] }}" = "true" ]; then
          pnpm install --frozen-lockfile
        else
          npm ci
        fi
        echo "::endgroup::"

    - name: ğŸ—ï¸ Bygg Storybook
      shell: bash
      env:
        STORYBOOK_BASE_PATH: ${{ inputs['storybook-base-path'] }}
      run: |
        echo "::group::Bygger Storybook"
        if [ "${{ inputs['use-pnpm'] }}" = "true" ]; then
          pnpm build-storybook --output-dir "${{ inputs['output-dir'] }}"
        else
          npm run build-storybook -- --output-dir "${{ inputs['output-dir'] }}"
        fi
        echo "::endgroup::"

    - name: ğŸš€ Deploy Storybook til GitHub Pages
      if: ${{ inputs['deploy-to-pages'] == 'true' }}
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: ${{ inputs['pages-branch'] }}
        folder: ${{ inputs['output-dir'] }}
        clean: false
        target-folder: ${{ inputs['pages-target-folder'] }}
        token: ${{ inputs['github-token'] }}
